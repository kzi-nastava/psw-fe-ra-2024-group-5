<div class="tour-view">
    <div class="tour-container">
        <div class="row">
            <div class="map-kp-wrapper">
                <div class="map-container">
                    <app-map [isViewOnly]="true"></app-map>
                </div>
                <div class="keypoints-container">
                    <div>
                        <h2>Key points:</h2>
                    </div>
                    <div class="progress-wrapper" *ngIf="tour">
                        <ul>
                            <li *ngFor="let keyPoint of tour.keyPoints; let index = index" class="completed"
                                [style.top]="(index / (tour.keyPoints.length - 1)) * 100 + '%'">
                                <div class="inner-dot"></div>
                                <div class="node-content visible" (click)="openKeyPointDialog(keyPoint)">
                                    {{ keyPoint.name || 'Checkpoint ' + (index + 1) }}
                                </div>
                            </li>
                        </ul>
                        <div class="progress-bar" *ngIf="tour.keyPoints.length > 1" style="height: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="details-wrapper">
                <div class="details-title">
                    <div class="title-info">
                        <h1>{{tour?.name}}</h1>
                        <div class="stats">
                            <div class="stat">
                                <mat-icon>visibility</mat-icon>
                                <span>{{ tour?.numberOfViews }}</span>
                            </div>
                            <div class="stat">
                                <mat-icon>attach_money</mat-icon>
                                <span>{{ tour?.numberOfPurchases }} </span>
                            </div>
                            <div class="stat">
                                <mat-icon>check_circle</mat-icon>
                                <span>{{ tour?.numberOfCompletions }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="avg-grade">
                        <span class="star" *ngIf="getAverageRating() >= 1">&#9733;</span>
                        <span class="star" *ngIf="getAverageRating() >= 2">&#9733;</span>
                        <span class="star" *ngIf="getAverageRating() >= 3">&#9733;</span>
                        <span class="star" *ngIf="getAverageRating() >= 4">&#9733;</span>
                        <span class="star" *ngIf="getAverageRating() >= 5">&#9733;</span>
                    </div>
                </div>
                <div class="details">
                    <div class="details-col">
                        <div class="info-wrapper">
                            <div class="info">
                                <h2>Price: {{tour?.price?.amount}} {{getCurrency(tour?.price?.currency)}}</h2>
                                <h2>{{ getTourLevel(tour?.level) }} <span *ngIf="user?.role === 'author'">- {{
                                    getTourStatus(tour?.status) }}</span></h2>
                                <h2 *ngIf="tour?.status === 1">Published: {{ tour?.publishedTime | date }}</h2>
                                <h2 *ngIf="tour?.status === 2">Archived: {{ tour?.archivedTime | date }}</h2>
                            </div>
                            <div class="transport">
                                <h2>Transport Durations</h2>
                                <ul>
                                    <li *ngFor="let transport of tour?.transportDurations" class="transport-duration">
                                        <h4>{{ transport.duration }} min - {{ getTransport(transport.transport) }}</h4>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <h3>Tags: {{ tour?.tags }}</h3>
                        <div class="description outlined-desc">
                            {{tour?.description}}
                        </div>
                    </div>
                    <div class="buttons-col">
                        <button mat-button class="secondary button-mg"
                        *ngIf="tour?.status===1 && user?.role === 'tourist' && canBeBought" (click)="addToCart()">Buy
                        now</button>
                        <button mat-button class="secondary button-mg" *ngIf="tour?.status===1 && user?.role === 'author'"
                        (click)="archiveTour()">Archive</button>
                        <button mat-button class="secondary button-mg"
                            *ngIf="(tour?.status===2 || tour?.status===0) && user?.role === 'author'"
                            (click)="togglePublishForm()">Publish</button>
                        <button mat-button class="secondary button-mg"
                            *ngIf="tour?.status===1 && user?.role === 'tourist' && canBeActivated"
                            (click)="startTour()">Activate</button>
                        <button mat-button class="secondary button-mg"
                            *ngIf="tour?.status===1 && user?.role === 'tourist' && canBeReviewed"
                            (click)="openReviewDialog()">Add review</button>
                        <button mat-button class="secondary button-mg" *ngIf="user?.role === 'author'">Edit</button>
                    </div>
                    <div class="col">
                        <img *ngIf="getFirstKeyPointImage(); else defaultImage"
                        [src]="getFirstKeyPointImage()" alt="Keypoints Picture" class="img" />
                        <ng-template #defaultImage>
                            <img src="..\..\..\assets\images\pexels-florencia-potter-82066-351283.jpg" alt="Default Tour Keypoint Picture" class="img"/>
                        </ng-template>
                    </div>
                </div>
            </div>
        </div>

        <div *ngIf="showPublishForm" class="publish-form">
            <label>Price:</label>
            <div>
                <input type="number" [(ngModel)]="newPrice" placeholder="Enter price" required>
                <span [style]="{'margin-left': '10px'}">AC</span>
            </div>

            <button mat-button class="primary button-mg" (click)="publishTourWithPrice()">Confirm Publish</button>
        </div>



    </div>

    <div class="title-container">
        <h1 mat-dialog-title *ngIf="tour && tour.reviews && tour.reviews.length > 0; else noReviews">Reviews</h1>

        <ng-template #noReviews>
            <h1 mat-dialog-title>No Reviews Available</h1>
        </ng-template>
    </div>
    <div class="review-container" *ngIf="tour && tour.reviews && tour.reviews.length > 0">
        <div class="review-card" *ngFor="let review of tour?.reviews">
            <div class="reviewer-info">
                <div class="reviewer-image">
                    <img [src]="'data:image/jpeg;base64,' + (getUserProfile(review.touristId!)?.profileImage || '')"
                        alt="profile-picture" class="profile-picture" onerror="this.src='assets/images/profile.jpg'">
                </div>
                <div class="reviewer-name">
                    {{ getUserProfile(review.touristId!)?.name }} {{ getUserProfile(review.touristId!)?.surname }}
                </div>
            </div>
            <div class="image-container">
                <img [src]="'data:image/jpeg;base64,' + review.image" alt="review-picture" class="review-picture">
            </div>
            <div class="review-info">
                <p class="review-comment">{{review.comment}}</p>
                <div class="review-footer">
                    <div class="review-dates">
                        <div class="review-date">
                            <span class="date-label">Visited:</span>
                            {{review.visitDate | date:'MMM d, y'}}
                        </div>
                        <div class="review-date">
                            <span class="date-label">Reviewed:</span>
                            {{review.reviewDate | date:'MMM d, y'}}
                        </div>
                    </div>
                    <div class="star-rating">
                        <span class="star" *ngIf="review.rating >= 1">&#9733;</span>
                        <span class="star" *ngIf="review.rating >= 2">&#9733;</span>
                        <span class="star" *ngIf="review.rating >= 3">&#9733;</span>
                        <span class="star" *ngIf="review.rating >= 4">&#9733;</span>
                        <span class="star" *ngIf="review.rating >= 5">&#9733;</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="leaderboard-container">
        <h1>Leaderboard</h1>
        <xp-tour-leaderboard [tourId]="tourId" />
    </div>

</div>